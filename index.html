<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Tournoi Bike Polo - 17 √âquipes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 70px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Navigation sticky */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 15px 20px;
        }
        
        nav .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        nav button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        nav button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        nav button.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        nav button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .regenerate-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%) !important;
            animation: pulse 2s infinite;
        }
        
        .arbitrage-btn {
            background: linear-gradient(135deg, #ff7b00 0%, #ff8c00 100%) !important;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%) !important;
        }
        
        .lock-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        }
        
        .unlock-btn {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Sections */
        .section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h2 {
            color: #555;
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        h3 {
            color: #666;
            margin: 15px 0;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f9ff;
        }
        
        /* Groupes de couleurs */
        .groupe-matin {
            background: #fff3cd !important;
            color: #856404;
            font-weight: 600;
        }
        
        .groupe-milieu {
            background: #cfe2ff !important;
            color: #084298;
            font-weight: 600;
        }
        
        .groupe-fin {
            background: #f8d7da !important;
            color: #842029;
            font-weight: 600;
        }
        
        /* Validation */
        .validation-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .validation-item.valid {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .validation-item.invalid {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .validation-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        /* S√©lecteur d'√©quipe */
        .team-selector {
            margin: 20px 0;
            text-align: center;
        }
        
        select {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        /* Liste des matchs */
        .matches-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .match-item {
            padding: 8px;
            background: white;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
            font-size: 0.85em;
        }
        
        .match-item.played {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .match-item.not-played {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        /* Matchs manquants */
        .missing-match {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
        
        .missing-match button {
            margin: 5px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .missing-match button:hover {
            background: #0056b3;
        }
        
        .missing-match button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Arbitrage */
        .arbitre-cell {
            background: #e8f5e8 !important;
            font-weight: bold;
            color: #2d5f2d;
        }
        
        .arbitrage-row {
            background: #f0f8f0 !important;
        }
        
        /* Contr√¥les */
        .controls-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            color: #555;
        }
        
        .control-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .control-group button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .status-locked {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unlocked {
            background: #d4edda;
            color: #155724;
        }
        
        /* Messages d'erreur/succ√®s/info */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #bee5eb;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            nav button {
                font-size: 12px;
                padding: 8px 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .matches-list {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <button onclick="showSection('overview')" class="active">Vue d'ensemble</button>
            <button onclick="showSection('tous-matchs')">Tous les Matchs</button>
            <button onclick="showSection('planning-jour')">Planning par Jour</button>
            <button onclick="showSection('planning-equipe')">Planning par √âquipe</button>
            <button onclick="showSection('mon-equipe')">Mon √âquipe</button>
            <button onclick="showSection('finalisation')" id="finalisationBtn">üîß Finalisation</button>
            <button onclick="showSection('arbitrage')">üë®‚Äç‚öñÔ∏è Arbitrage</button>
            <button onclick="showSection('controles')">‚öôÔ∏è Contr√¥les</button>
            <button onclick="showSection('validation')">Validation</button>
            <button onclick="regenererPlanning()" class="regenerate-btn" id="regenerateBtn">üîÑ R√©g√©n√©rer Planning</button>
        </div>
    </nav>

    <div class="container">
        <!-- Vue d'ensemble -->
        <div id="overview" class="section active">
            <h1>üèÜ Tournoi Bike Polo - 17 √âquipes</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">√âquipes</div>
                    <div class="stat-value">17</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Matchs</div>
                    <div class="stat-value">136</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Terrains</div>
                    <div class="stat-value">3</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dur√©e Match</div>
                    <div class="stat-value">25 min</div>
                </div>
            </div>
            
            <h2>üìÖ R√©partition des Matchs</h2>
            <table>
                <thead>
                    <tr>
                        <th>Jour</th>
                        <th>Cr√©neaux</th>
                        <th>Matchs Possibles</th>
                        <th>Matchs/√âquipe Requis</th>
                        <th>Horaires</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Jeudi</td>
                        <td>17</td>
                        <td>51 (17√ó3)</td>
                        <td>6</td>
                        <td>9h30 - 16h35</td>
                    </tr>
                    <tr>
                        <td>Vendredi</td>
                        <td>17</td>
                        <td>51 (17√ó3)</td>
                        <td>6</td>
                        <td>9h30 - 16h35</td>
                    </tr>
                    <tr>
                        <td>Samedi</td>
                        <td>12</td>
                        <td>36 (12√ó3)</td>
                        <td>4 (flexible si n√©cessaire)</td>
                        <td>9h30 - 14h30</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f0f0;">
                        <td>TOTAL</td>
                        <td>46</td>
                        <td>138 places</td>
                        <td>16 par √©quipe</td>
                        <td>136 matchs requis</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="info-message">
                ‚ÑπÔ∏è <strong>Note importante :</strong> L'algorithme place les 136 matchs en respectant les contraintes.
                En cas de matchs manquants, ils seront automatiquement plac√©s le samedi avec d√©rogation √† la limite de 4 matchs par √©quipe.
            </div>
        </div>

        <!-- Tous les Matchs -->
        <div id="tous-matchs" class="section">
            <h1>üìã Liste Compl√®te des Matchs</h1>
            <div id="matchs-stats"></div>
            <h2>Tous les matchs du tournoi (136)</h2>
            <div id="tous-matchs-content"></div>
        </div>

        <!-- Planning par Jour -->
        <div id="planning-jour" class="section">
            <h1>üìÖ Planning par Jour</h1>
            <div id="planning-jour-content"></div>
        </div>

        <!-- Planning par √âquipe -->
        <div id="planning-equipe" class="section">
            <h1>üë• Planning par √âquipe</h1>
            <div id="planning-equipe-content"></div>
        </div>

        <!-- Mon √âquipe -->
        <div id="mon-equipe" class="section">
            <h1>‚öΩ Mon √âquipe</h1>
            <div class="team-selector">
                <label for="team-select">S√©lectionnez votre √©quipe : </label>
                <select id="team-select" onchange="updateMonEquipe()">
                    <option value="">-- Choisir une √©quipe --</option>
                </select>
            </div>
            <div id="mon-equipe-content"></div>
        </div>

        <!-- Finalisation -->
        <div id="finalisation" class="section">
            <h1>üîß Finalisation du Planning</h1>
            <div class="controls-section">
                <h3>üéØ Auto-finalisation</h3>
                <p>Placer automatiquement tous les matchs manquants le samedi (d√©rogation √† la r√®gle des 4 matchs/√©quipe)</p>
                <button onclick="autoFinalisationSamedi()" id="autoFinalisationBtn" style="background: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px 0;">
                    üöÄ Auto-finalisation Samedi
                </button>
            </div>
            <div id="finalisation-content"></div>
        </div>

        <!-- Arbitrage -->
        <div id="arbitrage" class="section">
            <h1>üë®‚Äç‚öñÔ∏è Arbitrage</h1>
            <div class="info-message">
                <strong>R√®gles d'arbitrage :</strong><br>
                ‚Ä¢ Les √©quipes qui ne jouent pas et ne vont pas jouer le prochain match arbitrent<br>
                ‚Ä¢ Chaque √©quipe arbitre environ 7¬±2 matchs<br>
                ‚Ä¢ Id√©alement 3-4 matchs d'affil√©e par √©quipe arbitre
            </div>
            <button onclick="genererArbitrage()" id="genererArbitrageBtn" style="padding: 15px 30px; background: #ff7b00; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 20px 0;">
                üéØ G√©n√©rer l'Arbitrage
            </button>
            <div id="arbitrage-content"></div>
        </div>

        <!-- Contr√¥les -->
        <div id="controles" class="section">
            <h1>‚öôÔ∏è Contr√¥les et Sauvegarde</h1>
            
            <div class="controls-section">
                <h3>üîí Verrouillage du Planning</h3>
                <p>Prot√©gez les modifications par mot de passe. <span id="lockStatus" class="status-indicator status-unlocked">üîì D√âVERROUILL√â</span></p>
                
                <div class="controls-grid">
                    <div class="control-group">
                        <label for="passwordInput">Mot de passe :</label>
                        <input type="password" id="passwordInput" placeholder="Entrez le mot de passe">
                        <button onclick="toggleLock()" id="lockToggleBtn" class="unlock-btn">üîí Verrouiller</button>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>üíæ Sauvegarde et Chargement</h3>
                <p>Sauvegardez votre planning complet (matchs + arbitrage) ou chargez une planification existante.</p>
                
                <div class="controls-grid">
                    <div class="control-group">
                        <label>Sauvegarder :</label>
                        <button onclick="sauvegarderPlanning()" class="save-btn">üì• T√©l√©charger Planning</button>
                    </div>
                    
                    <div class="control-group">
                        <label for="fileInput">Charger un planning :</label>
                        <input type="file" id="fileInput" accept=".json" onchange="chargerPlanning(event)">
                    </div>
                    
                    <div class="control-group">
                        <label>Actions rapides :</label>
                        <button onclick="exporterCSV()" style="background: #17a2b8; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üìä Exporter CSV</button>
                    </div>
                </div>
            </div>

            <div class="info-message">
                <strong>üí° Conseils d'utilisation :</strong><br>
                ‚Ä¢ Verrouillez le planning une fois finalis√© pour √©viter les modifications accidentelles<br>
                ‚Ä¢ Sauvegardez r√©guli√®rement votre travail<br>
                ‚Ä¢ Le fichier de sauvegarde contient tous les donn√©es : planning, arbitrage, et configuration
            </div>
        </div>

        <!-- Validation -->
        <div id="validation" class="section">
            <h1>‚úÖ Validation du Planning</h1>
            <div id="validation-content"></div>
        </div>
    </div>

    <script>
        // Configuration du tournoi
        const CONFIG = {
            nbEquipes: 17,
            nbTerrains: 3,
            dureeMatch: 25, // minutes
            heureDebut: { h: 9, m: 30 },
            jours: [
                { nom: 'Jeudi', creneaux: 17 },
                { nom: 'Vendredi', creneaux: 17 },
                { nom: 'Samedi', creneaux: 12 }
            ],
            matchsParEquipe: [6, 6, 4] // Jeudi, Vendredi, Samedi (flexible pour samedi)
        };

        // Noms des √©quipes avec joueurs
        const EQUIPES = {
            1: 'SQUADRA VENERE (Caro, Piernok, Tristan, Kostia)',
            2: 'BIG TYRE (Jenny, Ben, Guilhem, Graham)',
            3: 'MTP 4 (Laurent, L√©a, Bernie, Gas)',
            4: 'UNDERDOGS (Coralie, Ana√Øs, Ella, Martin)',
            5: 'GOLDEN GOLD (Elodie, Mehdi, Morgan, Quentin)',
            6: 'J\'ADORE HARDCORE (Julia, Tomtox, Tony, Johnny)',
            7: 'MTP 2 (Cal, Jason, Luce, Rem\'s)',
            8: 'VANDALITO (Jovina, Vincent, Riton, Alban)',
            9: 'BETTER CALL SAULE (Bulle, Paco, Robin, Manu)',
            10: 'MTP 5 WHO RUN THE WORLD (Karen, Capucine, Cl√©mence, Lucas)',
            11: 'ALBASTAR (Dani, Oscar, Sylvio, Dev)',
            12: 'ONLY ONE (Lanza, Adrian, √ârik, TBA)',
            13: 'MTP 1 LOVELY (Victor, Pablo, Vicky, Jibbz)',
            14: 'BIG DOGS (Alejandro, Gas, Remi, Alix)',
            15: 'JUJUSAITSTOUPHAIR (Julien, Romain, Justine, Stouph)',
            16: 'MASSILIA MALLETS (Nico, Louise, Gaby, Lucas)',
            17: 'MTP 3 (Ana√Øs, Boris, Gohu, √âtienne)'
        };

        // Variables globales
        let planning = [];
        let tousLesMatchs = [];
        let matchsJoues = new Set();
        let arbitrage = [];
        let planningVerrouille = false;
        const MOT_DE_PASSE = "MontpellierBikePolo@26082025MegaMixte!";

        // Fonction pour obtenir le nom d'une √©quipe
        function getNomEquipe(numero) {
            return EQUIPES[numero] || `√âquipe ${numero}`;
        }

        // G√©n√©rer tous les matchs possibles (136 matchs)
        function genererTousLesMatchs() {
            tousLesMatchs = [];
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                for (let j = i + 1; j <= CONFIG.nbEquipes; j++) {
                    tousLesMatchs.push({
                        id: `${i}-${j}`,
                        equipe1: i,
                        equipe2: j,
                        joue: false,
                        jour: null,
                        creneau: null,
                        terrain: null
                    });
                }
            }
            console.log(`Total de matchs g√©n√©r√©s: ${tousLesMatchs.length}`);
            return tousLesMatchs;
        }

        // Calculer l'heure d'un cr√©neau
        function calculerHeure(jourIdx, creneauIdx) {
            const totalMinutes = CONFIG.heureDebut.h * 60 + CONFIG.heureDebut.m + (creneauIdx * CONFIG.dureeMatch);
            const heures = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${heures.toString().padStart(2, '0')}h${minutes.toString().padStart(2, '0')}`;
        }

        // V√©rifier si une √©quipe peut jouer (contrainte de repos)
        function peutJouer(equipe, jourIdx, creneauIdx, planning) {
            // V√©rifier le cr√©neau pr√©c√©dent (repos obligatoire)
            if (creneauIdx > 0) {
                const creneauPrecedent = planning[jourIdx][creneauIdx - 1];
                for (let terrain of creneauPrecedent.terrains) {
                    if (terrain && (terrain.equipe1 === equipe || terrain.equipe2 === equipe)) {
                        return false; // L'√©quipe a jou√© au cr√©neau pr√©c√©dent
                    }
                }
            }
            return true;
        }

        // V√©rifier le verrouillage
        function verifierVerrouillage() {
            return planningVerrouille;
        }

        // Mettre √† jour l'√©tat des boutons
        function mettreAJourBoutons() {
            const boutons = [
                'regenerateBtn', 'finalisationBtn', 'genererArbitrageBtn', 'autoFinalisationBtn'
            ];
            
            boutons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = planningVerrouille;
                }
            });

            // D√©sactiver tous les boutons d'assignation manuelle
            const boutonsAssignation = document.querySelectorAll('.missing-match button');
            boutonsAssignation.forEach(btn => {
                btn.disabled = planningVerrouille;
            });
        }

        // Basculer le verrouillage
        function toggleLock() {
            const password = document.getElementById('passwordInput').value;
            
            if (!planningVerrouille) {
                // Verrouiller
                if (password === MOT_DE_PASSE) {
                    planningVerrouille = true;
                    document.getElementById('lockStatus').innerHTML = 'üîí VERROUILL√â';
                    document.getElementById('lockStatus').className = 'status-indicator status-locked';
                    document.getElementById('lockToggleBtn').innerHTML = 'üîì D√©verrouiller';
                    document.getElementById('lockToggleBtn').className = 'lock-btn';
                    document.getElementById('passwordInput').value = '';
                    alert('‚úÖ Planning verrouill√© !');
                } else {
                    alert('‚ùå Mot de passe incorrect !');
                    return;
                }
            } else {
                // D√©verrouiller
                if (password === MOT_DE_PASSE) {
                    planningVerrouille = false;
                    document.getElementById('lockStatus').innerHTML = 'üîì D√âVERROUILL√â';
                    document.getElementById('lockStatus').className = 'status-indicator status-unlocked';
                    document.getElementById('lockToggleBtn').innerHTML = 'üîí Verrouiller';
                    document.getElementById('lockToggleBtn').className = 'unlock-btn';
                    document.getElementById('passwordInput').value = '';
                    alert('‚úÖ Planning d√©verrouill√© !');
                } else {
                    alert('‚ùå Mot de passe incorrect !');
                    return;
                }
            }
            
            mettreAJourBoutons();
        }

        // Auto-finalisation le samedi
        function autoFinalisationSamedi() {
            if (verifierVerrouillage()) {
                alert('üîí Le planning est verrouill√© !');
                return;
            }

            const matchsManquants = tousLesMatchs.filter(m => !m.joue);
            
            if (matchsManquants.length === 0) {
                alert('‚úÖ Tous les matchs sont d√©j√† plac√©s !');
                return;
            }

            let matchsPlaces = 0;
            const jourSamediIdx = 2; // Index du samedi

            // Essayer de placer tous les matchs manquants le samedi
            for (let match of matchsManquants) {
                let matchPlace = false;
                
                // Chercher un cr√©neau libre le samedi
                for (let creneauIdx = 0; creneauIdx < CONFIG.jours[jourSamediIdx].creneaux && !matchPlace; creneauIdx++) {
                    for (let terrainIdx = 0; terrainIdx < CONFIG.nbTerrains && !matchPlace; terrainIdx++) {
                        
                        // V√©rifier si le cr√©neau est libre
                        if (!planning[jourSamediIdx][creneauIdx].terrains[terrainIdx]) {
                            
                            // V√©rifier le repos (on peut d√©roger mais on essaie de respecter quand possible)
                            if (peutJouer(match.equipe1, jourSamediIdx, creneauIdx, planning) && 
                                peutJouer(match.equipe2, jourSamediIdx, creneauIdx, planning)) {
                                
                                // Placer le match
                                planning[jourSamediIdx][creneauIdx].terrains[terrainIdx] = {
                                    equipe1: match.equipe1,
                                    equipe2: match.equipe2,
                                    matchId: match.id
                                };
                                
                                match.joue = true;
                                match.jour = CONFIG.jours[jourSamediIdx].nom;
                                match.creneau = creneauIdx;
                                match.terrain = terrainIdx + 1;
                                matchsJoues.add(match.id);
                                
                                matchsPlaces++;
                                matchPlace = true;
                            }
                        }
                    }
                }
                
                // Si on n'a pas pu placer avec le repos, placer quand m√™me (d√©rogation)
                if (!matchPlace) {
                    for (let creneauIdx = 0; creneauIdx < CONFIG.jours[jourSamediIdx].creneaux && !matchPlace; creneauIdx++) {
                        for (let terrainIdx = 0; terrainIdx < CONFIG.nbTerrains && !matchPlace; terrainIdx++) {
                            
                            if (!planning[jourSamediIdx][creneauIdx].terrains[terrainIdx]) {
                                // V√©rifier que les √©quipes ne jouent pas d√©j√† √† ce cr√©neau
                                const equipesCreneauActuel = new Set();
                                planning[jourSamediIdx][creneauIdx].terrains.forEach(terrain => {
                                    if (terrain) {
                                        equipesCreneauActuel.add(terrain.equipe1);
                                        equipesCreneauActuel.add(terrain.equipe2);
                                    }
                                });
                                
                                if (!equipesCreneauActuel.has(match.equipe1) && !equipesCreneauActuel.has(match.equipe2)) {
                                    planning[jourSamediIdx][creneauIdx].terrains[terrainIdx] = {
                                        equipe1: match.equipe1,
                                        equipe2: match.equipe2,
                                        matchId: match.id
                                    };
                                    
                                    match.joue = true;
                                    match.jour = CONFIG.jours[jourSamediIdx].nom;
                                    match.creneau = creneauIdx;
                                    match.terrain = terrainIdx + 1;
                                    matchsJoues.add(match.id);
                                    
                                    matchsPlaces++;
                                    matchPlace = true;
                                }
                            }
                        }
                    }
                }
            }

            // Mettre √† jour tous les affichages
            afficherTousLesMatchs();
            afficherPlanningParJour();
            afficherPlanningParEquipe();
            afficherFinalisation();
            validerPlanning();
            
            if (matchsPlaces > 0) {
                alert(`‚úÖ ${matchsPlaces} matchs plac√©s automatiquement le samedi !`);
            } else {
                alert('‚ö†Ô∏è Aucun match n\'a pu √™tre plac√© automatiquement.');
            }
        }

        // Algorithme de g√©n√©ration du planning am√©lior√©
        function genererPlanning() {
            if (verifierVerrouillage()) {
                alert('üîí Le planning est verrouill√© !');
                return;
            }

            console.log("=== D√©but de la g√©n√©ration du planning ===");
            
            // R√©initialiser
            planning = [[], [], []]; // [Jeudi, Vendredi, Samedi]
            matchsJoues = new Set();
            tousLesMatchs = genererTousLesMatchs();
            arbitrage = [[], [], []]; // R√©initialiser l'arbitrage
            
            // Statistiques par √©quipe
            let statsEquipes = {};
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                statsEquipes[i] = {
                    totalMatchs: 0,
                    matchsParJour: [0, 0, 0],
                    adversaires: new Set()
                };
            }
            
            // Pour chaque jour
            for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx];
                const maxMatchsParEquipe = CONFIG.matchsParEquipe[jourIdx];
                
                console.log(`\n--- ${jour.nom}: ${jour.creneaux} cr√©neaux ---`);
                
                // Pour chaque cr√©neau
                for (let creneauIdx = 0; creneauIdx < jour.creneaux; creneauIdx++) {
                    const creneau = {
                        heure: calculerHeure(jourIdx, creneauIdx),
                        terrains: []
                    };
                    
                    // √âquipes d√©j√† utilis√©es dans ce cr√©neau
                    let equipesUtilisees = new Set();
                    
                    // Pour chaque terrain
                    for (let terrainIdx = 0; terrainIdx < CONFIG.nbTerrains; terrainIdx++) {
                        let matchTrouve = null;
                        let meilleurScore = -1;
                        
                        // √âvaluer tous les matchs possibles
                        for (let match of tousLesMatchs) {
                            if (match.joue) continue;
                            
                            const e1 = match.equipe1;
                            const e2 = match.equipe2;
                            
                            // V√©rifications de base
                            if (equipesUtilisees.has(e1) || equipesUtilisees.has(e2)) continue;
                            if (statsEquipes[e1].matchsParJour[jourIdx] >= maxMatchsParEquipe) continue;
                            if (statsEquipes[e2].matchsParJour[jourIdx] >= maxMatchsParEquipe) continue;
                            
                            // V√©rifier le repos
                            if (!peutJouer(e1, jourIdx, creneauIdx, planning)) continue;
                            if (!peutJouer(e2, jourIdx, creneauIdx, planning)) continue;
                            
                            // Calculer un score de priorit√©
                            let score = 0;
                            
                            // Favoriser les √©quipes qui ont moins jou√©
                            score += (16 - statsEquipes[e1].totalMatchs) * 10;
                            score += (16 - statsEquipes[e2].totalMatchs) * 10;
                            
                            // Favoriser les √©quipes qui sont en retard sur ce jour
                            score += (maxMatchsParEquipe - statsEquipes[e1].matchsParJour[jourIdx]) * 5;
                            score += (maxMatchsParEquipe - statsEquipes[e2].matchsParJour[jourIdx]) * 5;
                            
                            // Bonus si c'est un match n√©cessaire pour compl√©ter le round robin
                            if (!statsEquipes[e1].adversaires.has(e2)) score += 20;
                            
                            if (score > meilleurScore) {
                                meilleurScore = score;
                                matchTrouve = match;
                            }
                        }
                        
                        if (matchTrouve) {
                            const e1 = matchTrouve.equipe1;
                            const e2 = matchTrouve.equipe2;
                            
                            creneau.terrains.push({
                                equipe1: e1,
                                equipe2: e2,
                                matchId: matchTrouve.id
                            });
                            
                            // Mettre √† jour les statistiques
                            equipesUtilisees.add(e1);
                            equipesUtilisees.add(e2);
                            statsEquipes[e1].totalMatchs++;
                            statsEquipes[e2].totalMatchs++;
                            statsEquipes[e1].matchsParJour[jourIdx]++;
                            statsEquipes[e2].matchsParJour[jourIdx]++;
                            statsEquipes[e1].adversaires.add(e2);
                            statsEquipes[e2].adversaires.add(e1);
                            
                            matchTrouve.joue = true;
                            matchTrouve.jour = jour.nom;
                            matchTrouve.creneau = creneauIdx;
                            matchTrouve.terrain = terrainIdx + 1;
                            matchsJoues.add(matchTrouve.id);
                        } else {
                            creneau.terrains.push(null);
                        }
                    }
                    
                    planning[jourIdx].push(creneau);
                }
            }
            
            // Afficher les statistiques finales
            console.log("\n=== Statistiques finales ===");
            console.log(`Matchs plac√©s: ${matchsJoues.size}/136`);
            
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                const stats = statsEquipes[i];
                console.log(`${getNomEquipe(i)}: ${stats.totalMatchs} matchs (${stats.matchsParJour.join('+')}), ${stats.adversaires.size} adversaires diff√©rents`);
            }
            
            return { planning, statsEquipes };
        }

        // Afficher la finalisation
        function afficherFinalisation() {
            const matchsManquants = tousLesMatchs.filter(m => !m.joue);
            let html = '';
            
            if (matchsManquants.length === 0) {
                html += '<div class="success-message">üéâ Tous les matchs sont planifi√©s ! Le planning est complet.</div>';
            } else {
                html += `<div class="warning-message">‚ö†Ô∏è ${matchsManquants.length} matchs ne sont pas encore planifi√©s. Utilisez l'auto-finalisation ou assignez-les manuellement.</div>`;
                html += '<h2>Matchs manquants - Assignation manuelle</h2>';
                
                matchsManquants.forEach(match => {
                    html += '<div class="missing-match">';
                    html += `<strong>${getNomEquipe(match.equipe1)} vs ${getNomEquipe(match.equipe2)}</strong><br>`;
                    html += 'Assigner √† : ';
                    
                    // G√©n√©rer les options de cr√©neaux disponibles
                    let creneauxDisponibles = false;
                    for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                        for (let creneauIdx = 0; creneauIdx < CONFIG.jours[jourIdx].creneaux; creneauIdx++) {
                            for (let terrainIdx = 0; terrainIdx < CONFIG.nbTerrains; terrainIdx++) {
                                if (!planning[jourIdx][creneauIdx].terrains[terrainIdx]) {
                                    // V√©rifier si les √©quipes peuvent jouer √† ce cr√©neau
                                    if (peutJouer(match.equipe1, jourIdx, creneauIdx, planning) && 
                                        peutJouer(match.equipe2, jourIdx, creneauIdx, planning)) {
                                        const heure = calculerHeure(jourIdx, creneauIdx);
                                        html += `<button onclick="assignerMatch('${match.id}', ${jourIdx}, ${creneauIdx}, ${terrainIdx})" ${planningVerrouille ? 'disabled' : ''}>
                                            ${CONFIG.jours[jourIdx].nom} ${heure} T${terrainIdx + 1}
                                        </button>`;
                                        creneauxDisponibles = true;
                                    }
                                }
                            }
                        }
                    }
                    
                    if (!creneauxDisponibles) {
                        html += '<span style="color: #dc3545; font-style: italic;">Aucun cr√©neau disponible avec repos</span>';
                    }
                    
                    html += '</div>';
                });
            }
            
            document.getElementById('finalisation-content').innerHTML = html;
        }

        // Assigner un match manuellement
        function assignerMatch(matchId, jourIdx, creneauIdx, terrainIdx) {
            if (verifierVerrouillage()) {
                alert('üîí Le planning est verrouill√© !');
                return;
            }

            const match = tousLesMatchs.find(m => m.id === matchId);
            if (!match || match.joue) return;
            
            // V√©rifier la disponibilit√© du cr√©neau
            if (planning[jourIdx][creneauIdx].terrains[terrainIdx]) {
                alert('Ce cr√©neau est d√©j√† occup√© !');
                return;
            }
            
            // Assigner le match
            planning[jourIdx][creneauIdx].terrains[terrainIdx] = {
                equipe1: match.equipe1,
                equipe2: match.equipe2,
                matchId: match.id
            };
            
            match.joue = true;
            match.jour = CONFIG.jours[jourIdx].nom;
            match.creneau = creneauIdx;
            match.terrain = terrainIdx + 1;
            matchsJoues.add(match.id);
            
            // Mettre √† jour les affichages
            afficherTousLesMatchs();
            afficherPlanningParJour();
            afficherPlanningParEquipe();
            afficherFinalisation();
            validerPlanning();
            
            alert(`Match ${getNomEquipe(match.equipe1)} vs ${getNomEquipe(match.equipe2)} assign√© avec succ√®s !`);
        }

        // G√©n√©rer l'arbitrage
        function genererArbitrage() {
            if (verifierVerrouillage()) {
                alert('üîí Le planning est verrouill√© !');
                return;
            }

            console.log("=== G√©n√©ration de l'arbitrage ===");
            
            // R√©initialiser l'arbitrage
            arbitrage = [[], [], []];
            let statsArbitrage = {};
            
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                statsArbitrage[i] = {
                    totalArbitrages: 0,
                    dernierArbitrage: -10, // Pour g√©rer les s√©quences
                    sequenceActuelle: 0
                };
            }
            
            // Pour chaque jour
            for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx];
                
                // Pour chaque cr√©neau
                for (let creneauIdx = 0; creneauIdx < jour.creneaux; creneauIdx++) {
                    const creneauPlanning = planning[jourIdx][creneauIdx];
                    const creneauArbitrage = { heure: creneauPlanning.heure, arbitres: [] };
                    
                    // √âquipes qui jouent √† ce cr√©neau
                    let equipesQuiJouent = new Set();
                    creneauPlanning.terrains.forEach(terrain => {
                        if (terrain) {
                            equipesQuiJouent.add(terrain.equipe1);
                            equipesQuiJouent.add(terrain.equipe2);
                        }
                    });
                    
                    // √âquipes qui jouent au cr√©neau suivant
                    let equipesQuiJouentProchain = new Set();
                    if (creneauIdx + 1 < jour.creneaux) {
                        const creneauSuivant = planning[jourIdx][creneauIdx + 1];
                        creneauSuivant.terrains.forEach(terrain => {
                            if (terrain) {
                                equipesQuiJouentProchain.add(terrain.equipe1);
                                equipesQuiJouentProchain.add(terrain.equipe2);
                            }
                        });
                    }
                    
                    // √âquipes disponibles pour arbitrer
                    let equipesDisponibles = [];
                    for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                        if (!equipesQuiJouent.has(i) && !equipesQuiJouentProchain.has(i)) {
                            equipesDisponibles.push(i);
                        }
                    }
                    
                    // Assigner les arbitres pour chaque terrain avec match
                    let nbMatchs = creneauPlanning.terrains.filter(t => t !== null).length;
                    for (let terrainIdx = 0; terrainIdx < nbMatchs; terrainIdx++) {
                        let arbitreChoisi = null;
                        let meilleurScore = -1;
                        
                        for (let equipe of equipesDisponibles) {
                            if (creneauArbitrage.arbitres.includes(equipe)) continue; // D√©j√† arbitre ce cr√©neau
                            
                            let score = 0;
                            
                            // Favoriser les √©quipes qui ont moins arbitr√©
                            score += (8 - statsArbitrage[equipe].totalArbitrages) * 10;
                            
                            // Favoriser la continuit√© si l'√©quipe arbitrait r√©cemment
                            if (statsArbitrage[equipe].dernierArbitrage === creneauIdx - 1) {
                                score += 5; // Bonus pour continuer une s√©quence
                                if (statsArbitrage[equipe].sequenceActuelle < 4) {
                                    score += 3; // Bonus suppl√©mentaire si la s√©quence n'est pas trop longue
                                }
                            }
                            
                            // P√©nalit√© si la s√©quence devient trop longue
                            if (statsArbitrage[equipe].sequenceActuelle >= 4) {
                                score -= 10;
                            }
                            
                            if (score > meilleurScore) {
                                meilleurScore = score;
                                arbitreChoisi = equipe;
                            }
                        }
                        
                        if (arbitreChoisi) {
                            creneauArbitrage.arbitres.push(arbitreChoisi);
                            
                            // Mettre √† jour les stats
                            statsArbitrage[arbitreChoisi].totalArbitrages++;
                            
                            if (statsArbitrage[arbitreChoisi].dernierArbitrage === creneauIdx - 1) {
                                statsArbitrage[arbitreChoisi].sequenceActuelle++;
                            } else {
                                statsArbitrage[arbitreChoisi].sequenceActuelle = 1;
                            }
                            statsArbitrage[arbitreChoisi].dernierArbitrage = creneauIdx;
                            
                            // Retirer de la liste des disponibles pour ce cr√©neau
                            equipesDisponibles = equipesDisponibles.filter(e => e !== arbitreChoisi);
                        }
                    }
                    
                    arbitrage[jourIdx].push(creneauArbitrage);
                }
            }
            
            console.log("=== Statistiques d'arbitrage ===");
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                console.log(`${getNomEquipe(i)}: ${statsArbitrage[i].totalArbitrages} arbitrages`);
            }
            
            afficherArbitrage();
        }

        // Afficher l'arbitrage
        function afficherArbitrage() {
            let html = '';
            
            // Stats globales
            let statsArbitrage = {};
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                statsArbitrage[i] = 0;
            }
            
            arbitrage.forEach(jour => {
                jour.forEach(creneau => {
                    creneau.arbitres.forEach(arbitre => {
                        statsArbitrage[arbitre]++;
                    });
                });
            });
            
            html += '<h2>üìä Statistiques d\'arbitrage</h2>';
            html += '<div class="stats-grid">';
            
            let totalArbitrages = Object.values(statsArbitrage).reduce((a, b) => a + b, 0);
            let moyenne = totalArbitrages / CONFIG.nbEquipes;
            let min = Math.min(...Object.values(statsArbitrage));
            let max = Math.max(...Object.values(statsArbitrage));
            
            html += `<div class="stat-card"><div class="stat-label">Total Arbitrages</div><div class="stat-value">${totalArbitrages}</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Moyenne/√âquipe</div><div class="stat-value">${moyenne.toFixed(1)}</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Min - Max</div><div class="stat-value">${min} - ${max}</div></div>`;
            html += '</div>';
            
            // D√©tail par √©quipe
            html += '<h3>R√©partition par √©quipe</h3>';
            html += '<table><thead><tr><th>√âquipe</th><th>Nb Arbitrages</th><th>√âcart √† la moyenne</th></tr></thead><tbody>';
            
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                const nb = statsArbitrage[i];
                const ecart = nb - moyenne;
                const couleur = Math.abs(ecart) <= 1 ? '#d4edda' : (ecart > 1 ? '#f8d7da' : '#fff3cd');
                
                html += `<tr style="background: ${couleur}">`;
                html += `<td>${getNomEquipe(i)}</td>`;
                html += `<td>${nb}</td>`;
                html += `<td>${ecart > 0 ? '+' : ''}${ecart.toFixed(1)}</td>`;
                html += '</tr>';
            }
            html += '</tbody></table>';
            
            // Planning d'arbitrage par jour
            for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx];
                html += `<h2>${jour.nom} - Arbitrage</h2>`;
                
                html += '<table>';
                html += '<thead><tr><th>Heure</th><th>Terrain 1</th><th>Terrain 2</th><th>Terrain 3</th><th>Arbitres</th></tr></thead>';
                html += '<tbody>';
                
                planning[jourIdx].forEach((creneau, creneauIdx) => {
                    html += '<tr>';
                    html += `<td><strong>${creneau.heure}</strong></td>`;
                    
                    // Afficher les matchs
                    creneau.terrains.forEach(terrain => {
                        if (terrain) {
                            html += `<td style="font-size: 0.8em;">${getNomEquipe(terrain.equipe1)} vs ${getNomEquipe(terrain.equipe2)}</td>`;
                        } else {
                            html += '<td style="color: #999;">-</td>';
                        }
                    });
                    
                    // Afficher les arbitres
                    const arbitresCreneaux = arbitrage[jourIdx] && arbitrage[jourIdx][creneauIdx];
                    if (arbitresCreneaux && arbitresCreneaux.arbitres.length > 0) {
                        const nomsArbitres = arbitresCreneaux.arbitres.map(a => getNomEquipe(a)).join(', ');
                        html += `<td class="arbitre-cell" style="font-size: 0.8em;">${nomsArbitres}</td>`;
                    } else {
                        html += '<td style="color: #999;">Aucun arbitre</td>';
                    }
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('arbitrage-content').innerHTML = html;
        }

        // Obtenir les matchs d'arbitrage pour une √©quipe
        function getArbitragesEquipe(equipe) {
            const arbitragesEquipe = [];
            
            for (let jourIdx = 0; jourIdx < arbitrage.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx].nom;
                
                arbitrage[jourIdx].forEach((creneau, creneauIdx) => {
                    if (creneau.arbitres.includes(equipe)) {
                        arbitragesEquipe.push({
                            jour: jour,
                            heure: creneau.heure,
                            creneauIdx: creneauIdx
                        });
                    }
                });
            }
            
            return arbitragesEquipe;
        }

        // Sauvegarder le planning
        function sauvegarderPlanning() {
            const donnees = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                config: CONFIG,
                equipes: EQUIPES,
                planning: planning,
                tousLesMatchs: tousLesMatchs,
                matchsJoues: Array.from(matchsJoues),
                arbitrage: arbitrage
            };

            const blob = new Blob([JSON.stringify(donnees, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `tournoi-bike-polo-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Planning sauvegard√© !');
        }

        // Charger un planning
        function chargerPlanning(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const donnees = JSON.parse(e.target.result);
                    
                    // V√©rifier la validit√©
                    if (!donnees.version || !donnees.planning || !donnees.tousLesMatchs) {
                        throw new Error("Format de fichier invalide");
                    }
                    
                    // Charger les donn√©es
                    planning = donnees.planning;
                    tousLesMatchs = donnees.tousLesMatchs;
                    matchsJoues = new Set(donnees.matchsJoues || []);
                    arbitrage = donnees.arbitrage || [[], [], []];
                    
                    // Mettre √† jour tous les affichages
                    afficherTousLesMatchs();
                    afficherPlanningParJour();
                    afficherPlanningParEquipe();
                    afficherFinalisation();
                    afficherArbitrage();
                    validerPlanning();
                    
                    // R√©initialiser la s√©lection d'√©quipe
                    document.getElementById('team-select').value = '';
                    document.getElementById('mon-equipe-content').innerHTML = '<p>Veuillez s√©lectionner une √©quipe.</p>';
                    
                    alert('‚úÖ Planning charg√© avec succ√®s !');
                    
                } catch (error) {
                    alert('‚ùå Erreur lors du chargement du fichier : ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // R√©initialiser l'input
        }

        // Exporter en CSV
        function exporterCSV() {
            let csv = 'Jour,Heure,Terrain,Equipe1,Equipe2,Arbitres\n';
            
            for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx].nom;
                
                planning[jourIdx].forEach((creneau, creneauIdx) => {
                    const arbitresCreneaux = arbitrage[jourIdx] && arbitrage[jourIdx][creneauIdx] ? 
                        arbitrage[jourIdx][creneauIdx].arbitres.map(a => getNomEquipe(a)).join(';') : '';
                    
                    creneau.terrains.forEach((terrain, terrainIdx) => {
                        if (terrain) {
                            csv += `${jour},${creneau.heure},${terrainIdx + 1},"${getNomEquipe(terrain.equipe1)}","${getNomEquipe(terrain.equipe2)}","${arbitresCreneaux}"\n`;
                        }
                    });
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `tournoi-bike-polo-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Planning export√© en CSV !');
        }

        // Afficher tous les matchs
        function afficherTousLesMatchs() {
            let html = '';
            
            // Statistiques
            const matchsJouesCount = tousLesMatchs.filter(m => m.joue).length;
            const pourcentage = Math.round((matchsJouesCount / 136) * 100);
            
            html += '<div class="stats-grid">';
            html += `<div class="stat-card ${matchsJouesCount === 136 ? 'style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);"' : ''}">`;
            html += '<div class="stat-label">Matchs Plac√©s</div>';
            html += `<div class="stat-value">${matchsJouesCount}/136</div>`;
            html += `<div class="stat-label">${pourcentage}%</div>`;
            html += '</div>';
            html += '</div>';
            
            if (matchsJouesCount < 136) {
                html += '<div class="error-message">‚ö†Ô∏è Attention : Tous les matchs n\'ont pas pu √™tre plac√©s. V√©rifiez la section "Finalisation".</div>';
            }
            
            // Liste des matchs
            html += '<div class="matches-list">';
            tousLesMatchs.forEach(match => {
                const status = match.joue ? 'played' : 'not-played';
                const statusText = match.joue ? '‚úÖ' : '‚ùå';
                html += `<div class="match-item ${status}">`;
                html += `${statusText} ${getNomEquipe(match.equipe1)} vs ${getNomEquipe(match.equipe2)}`;
                if (match.joue) {
                    html += `<br><small>${match.jour} - ${match.creneau + 1}¬∞ - T${match.terrain}</small>`;
                }
                html += '</div>';
            });
            html += '</div>';
            
            document.getElementById('tous-matchs-content').innerHTML = html;
        }

        // Afficher le planning par jour
        function afficherPlanningParJour() {
            let html = '';
            
            for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx];
                html += `<h2>${jour.nom}</h2>`;
                
                const matchsJour = planning[jourIdx].reduce((acc, creneau) => {
                    return acc + creneau.terrains.filter(t => t !== null).length;
                }, 0);
                
                html += `<p>Matchs programm√©s : ${matchsJour} / ${jour.creneaux * 3} cr√©neaux disponibles</p>`;
                
                html += '<table>';
                html += '<thead><tr><th>Heure</th><th>Terrain 1</th><th>Terrain 2</th><th>Terrain 3</th></tr></thead>';
                html += '<tbody>';
                
                planning[jourIdx].forEach(creneau => {
                    html += '<tr>';
                    html += `<td><strong>${creneau.heure}</strong></td>`;
                    
                    creneau.terrains.forEach(terrain => {
                        if (terrain) {
                            html += `<td style="font-size: 0.85em;">${getNomEquipe(terrain.equipe1)} vs ${getNomEquipe(terrain.equipe2)}</td>`;
                        } else {
                            html += '<td style="color: #999;">-</td>';
                        }
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('planning-jour-content').innerHTML = html;
        }

        // Afficher le planning par √©quipe
        function afficherPlanningParEquipe() {
            let html = '';
            
            for (let equipe = 1; equipe <= CONFIG.nbEquipes; equipe++) {
                const matchsEquipe = getMatchsEquipe(equipe);
                
                html += `<h3>${getNomEquipe(equipe)} (${matchsEquipe.length} matchs)</h3>`;
                
                if (matchsEquipe.length === 0) {
                    html += '<p style="color: red;">‚ö†Ô∏è Aucun match programm√©</p>';
                } else {
                    html += '<table>';
                    html += '<thead><tr><th>N¬∞</th><th>Jour</th><th>Heure</th><th>Adversaire</th><th>Terrain</th></tr></thead>';
                    html += '<tbody>';
                    
                    matchsEquipe.forEach((match, idx) => {
                        html += '<tr>';
                        html += `<td>${idx + 1}</td>`;
                        html += `<td>${match.jour}</td>`;
                        html += `<td>${match.heure}</td>`;
                        html += `<td style="font-size: 0.85em;">${getNomEquipe(match.adversaire)}</td>`;
                        html += `<td>Terrain ${match.terrain}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // V√©rifier les adversaires manquants
                    const adversairesJoues = new Set(matchsEquipe.map(m => m.adversaire));
                    const adversairesManquants = [];
                    for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                        if (i !== equipe && !adversairesJoues.has(i)) {
                            adversairesManquants.push(i);
                        }
                    }
                    
                    if (adversairesManquants.length > 0) {
                        html += `<p style="color: orange; font-size: 0.85em;">‚ö†Ô∏è Adversaires manquants : ${adversairesManquants.map(a => getNomEquipe(a)).join(', ')}</p>`;
                    }
                }
            }
            
            document.getElementById('planning-equipe-content').innerHTML = html;
        }

        // Obtenir les matchs d'une √©quipe
        function getMatchsEquipe(equipe) {
            const matchsEquipe = [];
            
            for (let jourIdx = 0; jourIdx < planning.length; jourIdx++) {
                const jour = CONFIG.jours[jourIdx].nom;
                
                planning[jourIdx].forEach((creneau, creneauIdx) => {
                    creneau.terrains.forEach((terrain, terrainIdx) => {
                        if (terrain) {
                            if (terrain.equipe1 === equipe || terrain.equipe2 === equipe) {
                                const adversaire = terrain.equipe1 === equipe ? terrain.equipe2 : terrain.equipe1;
                                matchsEquipe.push({
                                    jour: jour,
                                    heure: creneau.heure,
                                    adversaire: adversaire,
                                    terrain: terrainIdx + 1
                                });
                            }
                        }
                    });
                });
            }
            
            return matchsEquipe;
        }

        // Valider le planning
        function validerPlanning() {
            let html = '';
            let toutValide = true;
            
            // V√©rifier le nombre total de matchs
            const totalMatchsJoues = matchsJoues.size;
            const totalMatchsAttendu = 136;
            
            html += '<h2>Validation Globale</h2>';
            
            if (totalMatchsJoues === totalMatchsAttendu) {
                html += '<div class="validation-item valid">';
                html += '<span class="validation-icon">‚úÖ</span>';
                html += `<span>Nombre total de matchs : ${totalMatchsJoues}/${totalMatchsAttendu}</span>`;
                html += '</div>';
            } else {
                html += '<div class="validation-item invalid">';
                html += '<span class="validation-icon">‚ùå</span>';
                html += `<span>Nombre total de matchs : ${totalMatchsJoues}/${totalMatchsAttendu} (${totalMatchsAttendu - totalMatchsJoues} matchs manquants)</span>`;
                html += '</div>';
                toutValide = false;
            }
            
            // V√©rifier pour chaque √©quipe
            html += '<h2>Validation par √âquipe</h2>';
            
            let equipesValides = 0;
            let detailsEquipes = [];
            
            for (let equipe = 1; equipe <= CONFIG.nbEquipes; equipe++) {
                const matchsEquipe = getMatchsEquipe(equipe);
                const matchsParJour = [0, 0, 0];
                
                matchsEquipe.forEach(match => {
                    if (match.jour === 'Jeudi') matchsParJour[0]++;
                    else if (match.jour === 'Vendredi') matchsParJour[1]++;
                    else if (match.jour === 'Samedi') matchsParJour[2]++;
                });
                
                const totalMatchs = matchsEquipe.length;
                
                // Flexibilit√© pour le samedi
                const repartitionCorrecte = 
                    matchsParJour[0] <= 6 && // Max 6 jeudi
                    matchsParJour[1] <= 6 && // Max 6 vendredi
                    matchsParJour[2] >= 4 && // Min 4 samedi
                    totalMatchs === 16; // Total correct
                
                // V√©rifier les adversaires
                const adversaires = new Set(matchsEquipe.map(m => m.adversaire));
                const tousAdversaires = adversaires.size === 16;
                
                const equipeValide = totalMatchs === 16 && tousAdversaires;
                if (equipeValide) equipesValides++;
                
                detailsEquipes.push({
                    equipe: equipe,
                    valide: equipeValide,
                    totalMatchs: totalMatchs,
                    matchsParJour: matchsParJour,
                    adversaires: adversaires.size
                });
            }
            
            // R√©sum√© des √©quipes
            if (equipesValides === CONFIG.nbEquipes) {
                html += '<div class="validation-item valid">';
                html += '<span class="validation-icon">‚úÖ</span>';
                html += `<span>Toutes les √©quipes (${equipesValides}/${CONFIG.nbEquipes}) ont leur planning complet</span>`;
                html += '</div>';
            } else {
                html += '<div class="validation-item invalid">';
                html += '<span class="validation-icon">‚ùå</span>';
                html += `<span>Seulement ${equipesValides}/${CONFIG.nbEquipes} √©quipes ont leur planning complet</span>`;
                html += '</div>';
                toutValide = false;
            }
            
            // D√©tails par √©quipe
            html += '<details style="margin-top: 20px;">';
            html += '<summary style="cursor: pointer; font-weight: bold;">Voir le d√©tail par √©quipe</summary>';
            html += '<div style="margin-top: 10px;">';
            
            detailsEquipes.forEach(detail => {
                if (detail.valide) {
                    html += '<div class="validation-item valid">';
                    html += '<span class="validation-icon">‚úÖ</span>';
                    html += `<span>${getNomEquipe(detail.equipe)} : ${detail.totalMatchs} matchs (${detail.matchsParJour.join('+')}), ${detail.adversaires} adversaires</span>`;
                    html += '</div>';
                } else {
                    html += '<div class="validation-item invalid">';
                    html += '<span class="validation-icon">‚ùå</span>';
                    html += `<span>${getNomEquipe(detail.equipe)} : ${detail.totalMatchs}/16 matchs (${detail.matchsParJour.join('+')}), ${detail.adversaires}/16 adversaires</span>`;
                    html += '</div>';
                }
            });
            
            html += '</div></details>';
            
            // V√©rifier les matchs cons√©cutifs (avec tol√©rance pour samedi)
            html += '<h2>Validation des Temps de Repos</h2>';
            let violationsRepos = [];
            
            for (let equipe = 1; equipe <= CONFIG.nbEquipes; equipe++) {
                for (let jourIdx = 0; jourIdx < planning.length; jourIdx++) {
                    let dernierCreneau = -2;
                    
                    planning[jourIdx].forEach((creneau, creneauIdx) => {
                        creneau.terrains.forEach(terrain => {
                            if (terrain && (terrain.equipe1 === equipe || terrain.equipe2 === equipe)) {
                                if (creneauIdx - dernierCreneau === 1) {
                                    // Tol√©rance pour le samedi
                                    if (jourIdx !== 2) {
                                        violationsRepos.push({
                                            equipe: equipe,
                                            jour: CONFIG.jours[jourIdx].nom,
                                            creneaux: [dernierCreneau, creneauIdx]
                                        });
                                    }
                                }
                                dernierCreneau = creneauIdx;
                            }
                        });
                    });
                }
            }
            
            if (violationsRepos.length === 0) {
                html += '<div class="validation-item valid">';
                html += '<span class="validation-icon">‚úÖ</span>';
                html += '<span>Temps de repos respect√©s (tol√©rance accord√©e le samedi)</span>';
                html += '</div>';
            } else {
                html += '<div class="validation-item invalid">';
                html += '<span class="validation-icon">‚ùå</span>';
                html += `<span>${violationsRepos.length} violation(s) du temps de repos d√©tect√©e(s)</span>`;
                html += '</div>';
                
                html += '<details>';
                html += '<summary style="cursor: pointer;">Voir les violations</summary>';
                violationsRepos.forEach(v => {
                    html += `<p>‚Ä¢ ${getNomEquipe(v.equipe)} le ${v.jour} (cr√©neaux ${v.creneaux[0]+1} et ${v.creneaux[1]+1})</p>`;
                });
                html += '</details>';
                
                toutValide = false;
            }
            
            // R√©sum√© final
            if (toutValide) {
                html = '<div class="success-message">üéâ Le planning est parfait ! Toutes les contraintes sont respect√©es.</div>' + html;
            } else {
                html = '<div class="error-message">‚ö†Ô∏è Le planning n√©cessite des ajustements. V√©rifiez la section "Finalisation".</div>' + html;
            }
            
            document.getElementById('validation-content').innerHTML = html;
        }

        // Initialiser le s√©lecteur d'√©quipe
        function initTeamSelector() {
            const select = document.getElementById('team-select');
            select.innerHTML = '<option value="">-- Choisir une √©quipe --</option>';
            for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = getNomEquipe(i);
                select.appendChild(option);
            }
        }

        // Mettre √† jour la section "Mon √âquipe" avec arbitrage
        function updateMonEquipe() {
            const select = document.getElementById('team-select');
            const equipe = parseInt(select.value);
            
            if (!equipe) {
                document.getElementById('mon-equipe-content').innerHTML = '<p>Veuillez s√©lectionner une √©quipe.</p>';
                return;
            }
            
            const matchsEquipe = getMatchsEquipe(equipe);
            const arbitragesEquipe = getArbitragesEquipe(equipe);
            
            let html = `<h2>Planning de ${getNomEquipe(equipe)}</h2>`;
            
            // Stats
            const matchsParJour = [0, 0, 0];
            matchsEquipe.forEach(match => {
                if (match.jour === 'Jeudi') matchsParJour[0]++;
                else if (match.jour === 'Vendredi') matchsParJour[1]++;
                else if (match.jour === 'Samedi') matchsParJour[2]++;
            });
            
            html += '<div class="stats-grid">';
            html += `<div class="stat-card"><div class="stat-label">Total Matchs</div><div class="stat-value">${matchsEquipe.length}/16</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Arbitrages</div><div class="stat-value">${arbitragesEquipe.length}</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Jeudi</div><div class="stat-value">${matchsParJour[0]}/6</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Vendredi</div><div class="stat-value">${matchsParJour[1]}/6</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Samedi</div><div class="stat-value">${matchsParJour[2]}/4+</div></div>`;
            html += '</div>';
            
            if (matchsEquipe.length === 0 && arbitragesEquipe.length === 0) {
                html += '<div class="error-message">Aucun match ni arbitrage programm√© pour cette √©quipe.</div>';
            } else {
                // Planning unifi√© par jour
                for (let jourIdx = 0; jourIdx < CONFIG.jours.length; jourIdx++) {
                    const jour = CONFIG.jours[jourIdx].nom;
                    
                    // Collecter matchs et arbitrages pour ce jour
                    const activitesJour = [];
                    
                    // Ajouter les matchs
                    matchsEquipe.forEach(match => {
                        if (match.jour === jour) {
                            activitesJour.push({
                                type: 'match',
                                heure: match.heure,
                                details: `vs ${getNomEquipe(match.adversaire)} (T${match.terrain})`
                            });
                        }
                    });
                    
                    // Ajouter les arbitrages
                    arbitragesEquipe.forEach(arbitrage => {
                        if (arbitrage.jour === jour) {
                            activitesJour.push({
                                type: 'arbitrage',
                                heure: arbitrage.heure,
                                details: 'Arbitrage'
                            });
                        }
                    });
                    
                    // Trier par heure
                    activitesJour.sort((a, b) => a.heure.localeCompare(b.heure));
                    
                    if (activitesJour.length > 0) {
                        html += `<h3>${jour}</h3>`;
                        html += '<table>';
                        html += '<thead><tr><th>Heure</th><th>Activit√©</th><th>D√©tails</th></tr></thead>';
                        html += '<tbody>';
                        
                        activitesJour.forEach(activite => {
                            const classeCSS = activite.type === 'arbitrage' ? 'arbitrage-row' : '';
                            const icone = activite.type === 'arbitrage' ? 'üë®‚Äç‚öñÔ∏è' : '‚öΩ';
                            
                            html += `<tr class="${classeCSS}">`;
                            html += `<td><strong>${activite.heure}</strong></td>`;
                            html += `<td>${icone} ${activite.type === 'arbitrage' ? 'Arbitrage' : 'Match'}</td>`;
                            html += `<td style="font-size: 0.85em;">${activite.details}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                    }
                }
                
                // Adversaires manquants (pour les matchs)
                if (matchsEquipe.length > 0) {
                    const adversairesJoues = new Set(matchsEquipe.map(m => m.adversaire));
                    const adversairesManquants = [];
                    for (let i = 1; i <= CONFIG.nbEquipes; i++) {
                        if (i !== equipe && !adversairesJoues.has(i)) {
                            adversairesManquants.push(i);
                        }
                    }
                    
                    if (adversairesManquants.length > 0) {
                        html += '<div class="error-message">';
                        html += `<strong>Adversaires manquants (${adversairesManquants.length}) :</strong><br>`;
                        html += adversairesManquants.map(a => getNomEquipe(a)).join(', ');
                        html += '</div>';
                    }
                }
            }
            
            document.getElementById('mon-equipe-content').innerHTML = html;
        }

        // Afficher une section
        function showSection(sectionId) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section s√©lectionn√©e
            document.getElementById(sectionId).classList.add('active');
            
            // Mettre √† jour la navigation
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Charger le contenu sp√©cifique
            if (sectionId === 'finalisation') {
                afficherFinalisation();
            }
            
            // Trouver le bouton actif
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(button => {
                if (button.onclick && button.onclick.toString().includes(sectionId)) {
                    button.classList.add('active');
                }
            });
        }

        // R√©g√©n√©rer le planning
        function regenererPlanning() {
            if (verifierVerrouillage()) {
                alert('üîí Le planning est verrouill√© !');
                return;
            }

            console.log("R√©g√©n√©ration du planning...");
            genererPlanning();
            afficherTousLesMatchs();
            afficherPlanningParJour();
            afficherPlanningParEquipe();
            afficherFinalisation();
            validerPlanning();
            
            // R√©initialiser l'arbitrage
            arbitrage = [[], [], []];
            document.getElementById('arbitrage-content').innerHTML = '<p>Veuillez g√©n√©rer l\'arbitrage apr√®s avoir finalis√© le planning.</p>';
            
            // R√©initialiser la s√©lection d'√©quipe
            document.getElementById('team-select').value = '';
            document.getElementById('mon-equipe-content').innerHTML = '<p>Veuillez s√©lectionner une √©quipe.</p>';
            
            // Message de confirmation
            alert('‚úÖ Planning r√©g√©n√©r√© !');
        }

        // Initialisation
        window.onload = function() {
            genererPlanning();
            initTeamSelector();
            afficherTousLesMatchs();
            afficherPlanningParJour();
            afficherPlanningParEquipe();
            afficherFinalisation();
            validerPlanning();
            mettreAJourBoutons();
        };
    </script>
</body>
</html>